<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kas Koperasi</title>

<style>
body{
  font-family:Arial;
  margin:0;
  background:#f4f6f9;
  font-size:14px;
}
header{
  background:#1e90ff;
  color:white;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{ padding:15px; }
.card{
  background:white;
  padding:15px;
  margin-bottom:15px;
  border-radius:10px;
  box-shadow:0 3px 8px rgba(0,0,0,.08);
}
input,select{
  width:100%;
  padding:8px;
  margin-bottom:8px;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#1e90ff;
  color:white;
  cursor:pointer;
}
.total{
  font-weight:bold;
  font-size:16px;
}
.row{
  display:flex;
  justify-content:space-between;
  margin-bottom:5px;
}
.transaksi{
  border-bottom:1px solid #ddd;
  padding:8px 0;
}
.masuk{ color:green; font-weight:bold; }
.keluar{ color:red; font-weight:bold; }
</style>
</head>
<body>

<header>
  <div>üí∞ Kas Koperasi</div>
  <button onclick="window.location='dashboard.html'">Kembali</button>
</header>

<div class="container">

  <!-- SALDO -->
  <div class="card total">
    <div>üíµ Cash : Rp <span id="saldoCash">0</span></div>
    <div>üè¶ Bank : Rp <span id="saldoBank">0</span></div>
    <hr>
    <div>üí∞ Total : Rp <span id="saldoTotal">0</span></div>
  </div>

  <!-- INPUT -->
  <div class="card" id="cardInput">
    <h3>Input Kas Manual</h3>

    <select id="sumberKas">
      <option value="cash">Cash</option>
      <option value="bank">Bank</option>
    </select>

    <select id="tipe">
      <option value="masuk">Kas Masuk</option>
      <option value="keluar">Kas Keluar</option>
    </select>

    <input type="number" id="jumlah" placeholder="Jumlah">
    <input type="text" id="keterangan" placeholder="Keterangan">

    <button id="btnSimpan">Simpan</button>
  </div>

  <!-- RIWAYAT -->
  <div class="card">
    <h3>Riwayat Transaksi</h3>
    <div id="riwayat"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ===== CONFIG FIREBASE ===== */

const firebaseConfig = {
  apiKey: "AIzaSyDd0s73-qW2uiOlBWR-afybFZzMafCHeSo",
  authDomain: "arfa-c7dee.firebaseapp.com",
  databaseURL: "https://arfa-c7dee-default-rtdb.firebaseio.com",
  projectId: "arfa-c7dee",
  storageBucket: "arfa-c7dee.firebasestorage.app",
  messagingSenderId: "468058520812",
  appId: "1:468058520812:web:f9cbc82fe7e88ecda9b9c9"
};
  
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const kasRef = ref(db,"koperasi/kas");

/* ===== ROLEBASE ===== */
const username = localStorage.getItem("user");
const role = localStorage.getItem("role") || "user";
if(!username) window.location.href="index.html";

/* Hanya admin bisa input */
if(role !== "admin"){
  document.getElementById("cardInput").style.display = "none";
}

/* ===== FORMAT RUPIAH ===== */
function rupiah(angka){
  return Number(angka || 0).toLocaleString("id-ID");
}

/* ================= SIMPAN ================= */
document.getElementById("btnSimpan")?.addEventListener("click", async ()=>{

  const sumberKas = document.getElementById("sumberKas").value;
  const tipe = document.getElementById("tipe").value;
  const jumlah = Number(document.getElementById("jumlah").value);
  const ket = document.getElementById("keterangan").value;

  if(!jumlah || jumlah<=0){
    alert("Jumlah wajib diisi");
    return;
  }

  await push(kasRef,{
    tipe,
    kategori:"manual",
    sumberKas,
    jumlah,
    keterangan: ket || "-",
    tanggal: Date.now()
  });

  document.getElementById("jumlah").value="";
  document.getElementById("keterangan").value="";
});

/* ================= TAMPIL DATA ================= */
onValue(kasRef, snapshot => {

  let masukCash=0, keluarCash=0;
  let masukBank=0, keluarBank=0;

  const riwayatDiv = document.getElementById("riwayat");
  riwayatDiv.innerHTML="";

  if(snapshot.exists()){
    const data = snapshot.val();

    // URUTKAN TERBARU
    const list = Object.values(data)
      .sort((a,b)=> (b.tanggal||0) - (a.tanggal||0));

    list.forEach(i=>{

      const jumlah = Number(i.jumlah) || 0;
      const tipe = i.tipe || "masuk";
      const sumberKas = i.sumberKas || "cash";

      // ===== TANGGAL AMAN =====
      let tanggalObj = null;
      if(i.tanggal && typeof i.tanggal === "number"){
        tanggalObj = new Date(i.tanggal);
      }
      const tanggalStr = tanggalObj
        ? tanggalObj.toLocaleString("id-ID")
        : "-";

      // HITUNG SALDO
      if(sumberKas==="cash"){
        if(tipe==="masuk") masukCash+=jumlah;
        else keluarCash+=jumlah;
      }

      if(sumberKas==="bank"){
        if(tipe==="masuk") masukBank+=jumlah;
        else keluarBank+=jumlah;
      }

      // TAMPIL RIWAYAT
      const div = document.createElement("div");
      div.className="transaksi";

      div.innerHTML=`
        <div class="row">
          <div>
            <span class="${tipe}">
              ${tipe==="masuk" ? "MASUK" : "KELUAR"}
            </span>
            (${sumberKas.toUpperCase()})
          </div>
          <div class="${tipe}">
            Rp ${rupiah(jumlah)}
          </div>
        </div>
        <div>${i.keterangan} - ${tanggalStr}</div>
      `;

      riwayatDiv.appendChild(div);
    });
  }

  const saldoCash = masukCash - keluarCash;
  const saldoBank = masukBank - keluarBank;
  const total = saldoCash + saldoBank;

  document.getElementById("saldoCash").innerText = rupiah(saldoCash);
  document.getElementById("saldoBank").innerText = rupiah(saldoBank);
  document.getElementById("saldoTotal").innerText = rupiah(total);
});
</script>

</body>
</html>