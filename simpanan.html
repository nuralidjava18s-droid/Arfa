<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simpanan Anggota</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
body{font-family:Arial;margin:0;background:#f4f6f9;}
/* HEADER */  
header{  
  background: linear-gradient(to right, #1e90ff, #0f3057);  
  color:white;  
  padding:14px 20px;  
  display:flex;  
  justify-content:space-between;  
  align-items:center;  
  box-shadow:0 3px 10px rgba(0,0,0,0.2);  
}  
  
.brand{  
  display:flex;  
  align-items:center;  
  gap:10px;  
}  
  
.brand img{  
  width:42px;  
  height:42px;  
  border-radius:50%;  
  object-fit:cover;  
}  
  
.brand-text .subtitle{  
  font-size:12px;  
  opacity:0.9;  
}  
  
.brand-text .title{  
  font-size:16px;  
  font-weight:bold;  
}  
  
.user-section{  
  position:relative;  
  cursor:pointer;  
  font-size:13px;  
}  
  
.container{padding:20px;}
.card{
  background:white;
  padding:15px;
  margin-bottom:15px;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,.1);
}
input,select{
  padding:8px;
  margin-bottom:10px;
  width:100%;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  color:white;
}
button:disabled{background:#aaa; cursor:not-allowed;}
.btn-primary{background:#1e90ff;}
.btn-edit{background:#ff9800;}
.btn-delete{background:#e74c3c;}
.total{font-size:18px;font-weight:bold;}
.anggota-card{
  border-left:5px solid #1e90ff;
  margin-bottom:12px;
  padding:12px;
  border-radius:8px;
  background:white;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
.anggota-card-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:5px;
}
.detail{
  margin-top:8px;
  padding-top:8px;
  border-top:1px solid #ddd;
}
.detail-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:5px;
}
</style>
</head>
<body>

   <header>  
  <div class="brand">  
    <img src="img/icon-192.png">  
    <div class="brand-text">  
      <div class="subtitle">Koperasi</div>  
      <div class="title">ARFA DRIVER</div>  
    </div>  
  </div>  
  <div>ðŸ’³ Simpanan Anggota</div>
  <div>
    <button class="btn-primary" onclick="window.location='dashboard.html'">Kembali</button>
  </div>
</header>

<div class="container">

  <div class="card total">
    Total Simpanan: Rp <span id="totalSimpanan">0</span>
  </div>

  <!-- FORM TAMBAH SIMPANAN -->
  <div id="formSimpanan" class="card">
    <h3>Tambah Simpanan</h3>
    <select id="anggotaSelect"></select>

    <select id="jenis">
      <option value="pokok">Simpanan Pokok</option>
      <option value="wajib">Simpanan Wajib</option>
      <option value="sukarela">Simpanan Sukarela</option>
    </select>

    <input type="number" id="jumlah" placeholder="Jumlah">
    <input type="text" id="keterangan" placeholder="Keterangan">

    <select id="sumberKas">
      <option value="cash">Kas Cash</option>
      <option value="bank">Kas Bank</option>
    </select>

    <button id="btnSimpan" class="btn-primary">Simpan</button>
  </div>

  <div class="card">
    <h3>Data Simpanan</h3>
    <div id="cardContainer"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, push, update, remove } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDd0s73-qW2uiOlBWR-afybFZzMafCHeSo",
  authDomain: "arfa-c7dee.firebaseapp.com",
  databaseURL: "https://arfa-c7dee-default-rtdb.firebaseio.com",
  projectId: "arfa-c7dee",
  storageBucket: "arfa-c7dee.firebasestorage.app",
  messagingSenderId: "468058520812",
  appId: "1:468058520812:web:f9cbc82fe7e88ecda9b9c9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const anggotaRef = ref(db,"koperasi/anggota");
const simpananRef = ref(db,"koperasi/simpanan");
const kasRef = ref(db,"koperasi/kas");

/* LOGIN & ROLE BASED */
const username = localStorage.getItem("user");
const role = localStorage.getItem("role") || "user"; // admin/user
if(!username) window.location.href="index.html";

// Hanya admin bisa tambah/edit/hapus
if(role !== "admin"){
  document.getElementById("formSimpanan").style.display="none";
}

/* LOAD ANGGOTA */
onValue(anggotaRef, snapshot=>{
  const select=document.getElementById("anggotaSelect");
  select.innerHTML="<option value=''>Pilih Anggota</option>";
  snapshot.forEach(child=>{
    const opt=document.createElement("option");
    opt.value=child.key;
    opt.textContent=child.val().nama;
    select.appendChild(opt);
  });
});

/* LOAD SIMPANAN */
let simpananRaw=[];
onValue(simpananRef, snapshot=>{
  simpananRaw=[];
  snapshot.forEach(child=>{
    simpananRaw.push({id:child.key,...child.val()});
  });
  renderData();
});

function renderData(){
  const container=document.getElementById("cardContainer");
  container.innerHTML="";
  let total=0;
  let rekap={};

  simpananRaw.forEach(item=>{
    if(!rekap[item.nama])
      rekap[item.nama]={pokok:0,wajib:0,sukarela:0,detail:[]};

    rekap[item.nama][item.jenis]+=Number(item.jumlah);
    rekap[item.nama].detail.push(item);
  });

  for(const nama in rekap){
    const totalAnggota=
      rekap[nama].pokok+
      rekap[nama].wajib+
      rekap[nama].sukarela;

    total+=totalAnggota;

    const card=document.createElement("div");
    card.className="anggota-card";

    let html=`
      <div class="anggota-card-row"><b>${nama}</b><b>Rp ${totalAnggota.toLocaleString("id-ID")}</b></div>
      <div>Pokok: Rp ${rekap[nama].pokok.toLocaleString("id-ID")}</div>
      <div>Wajib: Rp ${rekap[nama].wajib.toLocaleString("id-ID")}</div>
      <div>Sukarela: Rp ${rekap[nama].sukarela.toLocaleString("id-ID")}</div>
      <div class="detail">
    `;

    rekap[nama].detail.forEach(d=>{
      html+=`
        <div class="detail-row">
          <span>${d.jenis} - Rp ${Number(d.jumlah).toLocaleString("id-ID")}</span>
          <span>
            <button class="btn-edit" data-id="${d.id}" ${role!=="admin"?"disabled":""}>Edit</button>
            <button class="btn-delete" data-id="${d.id}" ${role!=="admin"?"disabled":""}>Hapus</button>
          </span>
        </div>
      `;
    });

    html+="</div>";
    card.innerHTML=html;
    container.appendChild(card);
  }

  document.getElementById("totalSimpanan").innerText=
    total.toLocaleString("id-ID");

  attachEvents();
}

/* EVENT EDIT & HAPUS (Hanya admin) */
function attachEvents(){
  if(role!=="admin") return; // user biasa tidak bisa edit/hapus

  document.querySelectorAll(".btn-edit").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=btn.dataset.id;
      const item=simpananRaw.find(s=>s.id===id);
      if(!item) return;

      const newJumlah=prompt("Ubah jumlah:",item.jumlah);
      if(newJumlah===null) return;

      await update(ref(db,`koperasi/simpanan/${id}`),{
        jumlah:Number(newJumlah)
      });

      // update kas juga
      if(item.kasId){
        await update(ref(db,`koperasi/kas/${item.kasId}`),{
          jumlah:Number(newJumlah)
        });
      }

      alert("Berhasil update");
    };
  });

  document.querySelectorAll(".btn-delete").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=btn.dataset.id;
      const item=simpananRaw.find(s=>s.id===id);
      if(!item) return;

      if(!confirm("Yakin hapus data?")) return;

      // hapus kas
      if(item.kasId){
        await remove(ref(db,`koperasi/kas/${item.kasId}`));
      }

      // hapus simpanan
      await remove(ref(db,`koperasi/simpanan/${id}`));

      alert("Data dihapus");
    };
  });
}

/* SIMPAN (Hanya admin) */
const btnSimpan=document.getElementById("btnSimpan");
if(role==="admin"){
  btnSimpan.onclick=async()=>{
    const select=document.getElementById("anggotaSelect");
    if(!select.value) return alert("Pilih anggota");

    const nama=select.options[select.selectedIndex].text;
    const jenis=document.getElementById("jenis").value;
    const jumlah=Number(document.getElementById("jumlah").value);
    const ket=document.getElementById("keterangan").value;
    const sumberKas=document.getElementById("sumberKas").value;

    if(!jumlah || jumlah<=0) return alert("Jumlah tidak valid");

    // simpan kas dulu
    const kasPush=await push(kasRef,{
      tipe:"masuk",
      kategori:"simpanan",
      sumberKas:sumberKas,
      keterangan:`Simpanan ${jenis} - ${nama}`,
      jumlah:jumlah,
      tanggal:new Date().toLocaleString()
    });

    const kasId=kasPush.key;

    // simpan simpanan
    await push(simpananRef,{
      anggotaId:select.value,
      nama,
      jenis,
      jumlah,
      keterangan:ket,
      tanggal:new Date().toLocaleString(),
      kasId:kasId
    });

    document.getElementById("jumlah").value="";
    document.getElementById("keterangan").value="";
  };
} else {
  btnSimpan.disabled=true;
}

</script>

</body>
</html>
